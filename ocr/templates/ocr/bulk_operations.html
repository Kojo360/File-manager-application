{% extends 'ocr/base.html' %}

{% block title %}Bulk Operations - File Manager{% endblock %}

{% block page_title %}Bulk File Operations{% endblock %}
{% block page_subtitle %}Manage multiple files efficiently with bulk operations{% endblock %}

{% block content %}
<div class="bulk-operations-container">
  <!-- Selection Controls -->
  <div class="selection-controls">
    <div class="control-section">
      <h3>
        <i class="fas fa-tasks"></i>
        File Selection
      </h3>
      <div class="control-buttons">
        <button class="btn-control" onclick="selectAll()">
          <i class="fas fa-check-square"></i>
          Select All
        </button>
        <button class="btn-control" onclick="selectNone()">
          <i class="fas fa-square"></i>
          Clear Selection
        </button>
        <button class="btn-control" onclick="selectByStatus('fully_indexed')">
          <i class="fas fa-check-circle"></i>
          Select Processed
        </button>
        <button class="btn-control" onclick="selectByStatus('failed')">
          <i class="fas fa-times-circle"></i>
          Select Failed
        </button>
      </div>
    </div>

    <div class="selected-info">
      <div class="info-item">
        <span class="label">Selected:</span>
        <span class="value" id="selected-count">0</span>
        <span class="unit">files</span>
      </div>
      <div class="info-item">
        <span class="label">Total Size:</span>
        <span class="value" id="selected-size">0 B</span>
      </div>
    </div>
  </div>

  <!-- Bulk Operations Panel -->
  <div class="operations-panel">
    <div class="panel-header">
      <h3>
        <i class="fas fa-cogs"></i>
        Available Operations
      </h3>
      <div class="operation-status" id="operation-status"></div>
    </div>

    <div class="operation-buttons">
      <button class="bulk-operation-btn delete" onclick="performBulkOperation('delete')" disabled>
        <i class="fas fa-trash"></i>
        <span>Delete Selected</span>
        <small>Permanently remove files</small>
      </button>

      <button class="bulk-operation-btn reprocess" onclick="performBulkOperation('reprocess')" disabled>
        <i class="fas fa-redo"></i>
        <span>Reprocess</span>
        <small>Queue for re-processing</small>
      </button>

      <button class="bulk-operation-btn download" onclick="performBulkOperation('download')" disabled>
        <i class="fas fa-download"></i>
        <span>Download ZIP</span>
        <small>Download as archive</small>
      </button>

      <button class="bulk-operation-btn move" onclick="showMoveDialog()" disabled>
        <i class="fas fa-folder-open"></i>
        <span>Organize</span>
        <small>Move to folder</small>
      </button>
    </div>
  </div>

  <!-- File Browser with Selection -->
  <div class="file-browser">
    <div class="browser-header">
      <h3>
        <i class="fas fa-files"></i>
        File Browser
      </h3>
      <div class="browser-controls">
        <div class="view-toggle">
          <button class="view-btn active" data-view="grid" onclick="setView('grid')">
            <i class="fas fa-th"></i>
          </button>
          <button class="view-btn" data-view="list" onclick="setView('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
        <div class="filter-controls">
          <select id="status-filter" onchange="filterFiles()">
            <option value="">All Statuses</option>
            <option value="fully_indexed">Fully Indexed</option>
            <option value="partially_indexed">Partially Indexed</option>
            <option value="failed">Failed</option>
          </select>
          <input type="text" id="search-filter" placeholder="Search files..." onkeyup="filterFiles()">
        </div>
      </div>
    </div>

    <div class="files-container" id="files-container">
      <!-- Files will be loaded here -->
    </div>

    <div class="loading-indicator" id="loading-indicator">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Loading files...</span>
    </div>
  </div>

  <!-- Progress Modal -->
  <div class="modal" id="progress-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Operation in Progress</h3>
        <button class="modal-close" onclick="closeModal('progress-modal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="progress-info">
          <div class="progress-text" id="progress-text">Preparing operation...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-stats">
            <span id="progress-current">0</span> of <span id="progress-total">0</span> files processed
          </div>
        </div>
        <div class="operation-results" id="operation-results"></div>
      </div>
    </div>
  </div>

  <!-- Move Dialog -->
  <div class="modal" id="move-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Organize Files</h3>
        <button class="modal-close" onclick="closeModal('move-modal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="folder-selection">
          <label>Select destination folder:</label>
          <select id="destination-folder">
            <option value="archive">Archive</option>
            <option value="documents">Documents</option>
            <option value="images">Images</option>
            <option value="temp">Temporary</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeModal('move-modal')">Cancel</button>
          <button class="btn-primary" onclick="confirmMove()">Move Files</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.bulk-operations-container {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Selection Controls */
.selection-controls {
  background: rgba(51, 65, 85, 0.9);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 20px;
  padding: 25px;
  margin-bottom: 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
}

.control-section h3 {
  color: white;
  font-size: 18px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.control-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-control {
  padding: 8px 16px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #3b82f6;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-control:hover {
  background: rgba(59, 130, 246, 0.2);
  border-color: #3b82f6;
}

.selected-info {
  display: flex;
  gap: 25px;
  align-items: center;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: white;
  font-size: 14px;
}

.info-item .label {
  color: rgba(255, 255, 255, 0.7);
}

.info-item .value {
  font-weight: 600;
  color: #3b82f6;
}

.info-item .unit {
  color: rgba(255, 255, 255, 0.6);
  font-size: 12px;
}

/* Operations Panel */
.operations-panel {
  background: rgba(51, 65, 85, 0.9);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 20px;
  padding: 25px;
  margin-bottom: 25px;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.panel-header h3 {
  color: white;
  font-size: 18px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.operation-status {
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
}

.operation-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.bulk-operation-btn {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 20px;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bulk-operation-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.bulk-operation-btn:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(15, 23, 42, 0.3);
}

.bulk-operation-btn.delete:not(:disabled):hover {
  border-color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

.bulk-operation-btn.reprocess:not(:disabled):hover {
  border-color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
}

.bulk-operation-btn.download:not(:disabled):hover {
  border-color: #22c55e;
  background: rgba(34, 197, 94, 0.1);
}

.bulk-operation-btn.move:not(:disabled):hover {
  border-color: #8b5cf6;
  background: rgba(139, 92, 246, 0.1);
}

.bulk-operation-btn i {
  font-size: 24px;
  margin-bottom: 5px;
}

.bulk-operation-btn span {
  font-size: 16px;
  font-weight: 600;
}

.bulk-operation-btn small {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
}

/* File Browser */
.file-browser {
  background: rgba(51, 65, 85, 0.9);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 20px;
  padding: 25px;
}

.browser-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

.browser-header h3 {
  color: white;
  font-size: 18px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.browser-controls {
  display: flex;
  align-items: center;
  gap: 15px;
}

.view-toggle {
  display: flex;
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 8px;
  overflow: hidden;
}

.view-btn {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: rgba(255, 255, 255, 0.7);
  cursor: pointer;
  transition: all 0.3s ease;
}

.view-btn.active {
  background: #3b82f6;
  color: white;
}

.filter-controls {
  display: flex;
  gap: 10px;
}

.filter-controls select,
.filter-controls input {
  padding: 8px 12px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 8px;
  color: white;
  font-size: 14px;
}

.filter-controls input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

.files-container {
  min-height: 400px;
  position: relative;
}

.files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

.files-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.file-item {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.file-item:hover {
  border-color: rgba(148, 163, 184, 0.4);
  transform: translateY(-1px);
}

.file-item.selected {
  border-color: #3b82f6;
  background: rgba(59, 130, 246, 0.1);
}

.file-checkbox {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(148, 163, 184, 0.3);
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.file-item.selected .file-checkbox {
  background: #3b82f6;
  border-color: #3b82f6;
}

.file-item.selected .file-checkbox::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 2px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.file-icon {
  font-size: 32px;
  color: #3b82f6;
  margin-bottom: 10px;
}

.file-name {
  color: white;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 5px;
  word-break: break-word;
}

.file-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
}

.file-status {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
}

.file-status.fully_indexed {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.file-status.partially_indexed {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.file-status.failed {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.loading-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 40px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 16px;
}

.loading-indicator.hidden {
  display: none;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(51, 65, 85, 0.95);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
}

.modal-header h3 {
  color: white;
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 20px;
  cursor: pointer;
  transition: color 0.3s ease;
}

.modal-close:hover {
  color: white;
}

.modal-body {
  padding: 25px;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(148, 163, 184, 0.2);
  border-radius: 4px;
  overflow: hidden;
  margin: 15px 0;
}

.progress-fill {
  height: 100%;
  background: #3b82f6;
  border-radius: 4px;
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  color: white;
  font-size: 16px;
  margin-bottom: 10px;
}

.progress-stats {
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  text-align: center;
}

.operation-results {
  margin-top: 20px;
}

.result-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(148, 163, 184, 0.1);
}

.result-item:last-child {
  border-bottom: none;
}

.result-file {
  color: white;
  font-size: 14px;
}

.result-status {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.result-status.success {
  background: rgba(34, 197, 94, 0.2);
  color: #22c55e;
}

.result-status.error {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-secondary,
.btn-primary {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-secondary {
  background: rgba(148, 163, 184, 0.2);
  border: 1px solid rgba(148, 163, 184, 0.3);
  color: rgba(255, 255, 255, 0.8);
}

.btn-primary {
  background: #3b82f6;
  border: 1px solid #3b82f6;
  color: white;
}

.btn-secondary:hover {
  background: rgba(148, 163, 184, 0.3);
}

.btn-primary:hover {
  background: #2563eb;
  border-color: #2563eb;
}

/* Responsive Design */
@media (max-width: 768px) {
  .bulk-operations-container {
    padding: 15px;
  }
  
  .selection-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .control-buttons {
    justify-content: center;
  }
  
  .selected-info {
    justify-content: center;
  }
  
  .operation-buttons {
    grid-template-columns: 1fr;
  }
  
  .browser-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .browser-controls {
    flex-direction: column;
    gap: 10px;
  }
  
  .filter-controls {
    flex-direction: column;
  }
  
  .files-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
  }
}
</style>

<script>
let selectedFiles = new Set();
let allFiles = [];
let currentView = 'grid';

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  loadFiles();
});

// Load files from API
async function loadFiles() {
  const loadingIndicator = document.getElementById('loading-indicator');
  const filesContainer = document.getElementById('files-container');
  
  loadingIndicator.classList.remove('hidden');
  
  try {
    const response = await fetch('/api/files/');
    const data = await response.json();
    
    allFiles = data.files;
    displayFiles(allFiles);
    
  } catch (error) {
    console.error('Error loading files:', error);
    filesContainer.innerHTML = '<div class="error-message">Failed to load files</div>';
  } finally {
    loadingIndicator.classList.add('hidden');
  }
}

// Display files in the container
function displayFiles(files) {
  const container = document.getElementById('files-container');
  const viewClass = currentView === 'grid' ? 'files-grid' : 'files-list';
  
  container.innerHTML = `<div class="${viewClass}" id="files-display"></div>`;
  const display = document.getElementById('files-display');
  
  files.forEach(file => {
    const fileElement = createFileElement(file);
    display.appendChild(fileElement);
  });
}

// Create individual file element
function createFileElement(file) {
  const div = document.createElement('div');
  div.className = 'file-item';
  div.dataset.filename = file.name;
  div.dataset.status = file.status;
  div.dataset.size = file.size;
  
  const isSelected = selectedFiles.has(file.name);
  if (isSelected) div.classList.add('selected');
  
  // Determine file icon
  const extension = file.name.split('.').pop().toLowerCase();
  let iconClass = 'fas fa-file';
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
    iconClass = 'fas fa-image';
  } else if (extension === 'pdf') {
    iconClass = 'fas fa-file-pdf';
  }
  
  div.innerHTML = `
    <div class="file-checkbox"></div>
    <div class="file-icon">
      <i class="${iconClass}"></i>
    </div>
    <div class="file-name">${file.name}</div>
    <div class="file-meta">
      <span class="file-status ${file.status}">${file.status.replace('_', ' ')}</span>
      <span class="file-size">${formatFileSize(file.size)}</span>
    </div>
  `;
  
  div.addEventListener('click', function() {
    toggleFileSelection(file.name, file.size);
  });
  
  return div;
}

// Toggle file selection
function toggleFileSelection(filename, fileSize) {
  const fileElement = document.querySelector(`[data-filename="${filename}"]`);
  
  if (selectedFiles.has(filename)) {
    selectedFiles.delete(filename);
    fileElement.classList.remove('selected');
  } else {
    selectedFiles.add(filename);
    fileElement.classList.add('selected');
  }
  
  updateSelectionInfo();
  updateOperationButtons();
}

// Update selection information display
function updateSelectionInfo() {
  const selectedCount = selectedFiles.size;
  const selectedSize = Array.from(selectedFiles).reduce((total, filename) => {
    const fileElement = document.querySelector(`[data-filename="${filename}"]`);
    return total + parseInt(fileElement.dataset.size);
  }, 0);
  
  document.getElementById('selected-count').textContent = selectedCount;
  document.getElementById('selected-size').textContent = formatFileSize(selectedSize);
}

// Update operation button states
function updateOperationButtons() {
  const hasSelection = selectedFiles.size > 0;
  const buttons = document.querySelectorAll('.bulk-operation-btn');
  
  buttons.forEach(button => {
    button.disabled = !hasSelection;
  });
  
  // Update status text
  const statusElement = document.getElementById('operation-status');
  if (hasSelection) {
    statusElement.textContent = `${selectedFiles.size} files selected`;
  } else {
    statusElement.textContent = 'No files selected';
  }
}

// Selection functions
function selectAll() {
  selectedFiles.clear();
  allFiles.forEach(file => {
    selectedFiles.add(file.name);
  });
  
  document.querySelectorAll('.file-item').forEach(element => {
    element.classList.add('selected');
  });
  
  updateSelectionInfo();
  updateOperationButtons();
}

function selectNone() {
  selectedFiles.clear();
  
  document.querySelectorAll('.file-item').forEach(element => {
    element.classList.remove('selected');
  });
  
  updateSelectionInfo();
  updateOperationButtons();
}

function selectByStatus(status) {
  selectedFiles.clear();
  
  document.querySelectorAll('.file-item').forEach(element => {
    element.classList.remove('selected');
    if (element.dataset.status === status) {
      selectedFiles.add(element.dataset.filename);
      element.classList.add('selected');
    }
  });
  
  updateSelectionInfo();
  updateOperationButtons();
}

// View functions
function setView(view) {
  currentView = view;
  
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  document.querySelector(`[data-view="${view}"]`).classList.add('active');
  displayFiles(allFiles);
  
  // Restore selection
  selectedFiles.forEach(filename => {
    const element = document.querySelector(`[data-filename="${filename}"]`);
    if (element) element.classList.add('selected');
  });
}

// Filter functions
function filterFiles() {
  const statusFilter = document.getElementById('status-filter').value;
  const searchFilter = document.getElementById('search-filter').value.toLowerCase();
  
  const filteredFiles = allFiles.filter(file => {
    const matchesStatus = !statusFilter || file.status === statusFilter;
    const matchesSearch = !searchFilter || file.name.toLowerCase().includes(searchFilter);
    return matchesStatus && matchesSearch;
  });
  
  displayFiles(filteredFiles);
  
  // Restore selection
  selectedFiles.forEach(filename => {
    const element = document.querySelector(`[data-filename="${filename}"]`);
    if (element) element.classList.add('selected');
  });
}

// Bulk operations
async function performBulkOperation(operation) {
  if (selectedFiles.size === 0) return;
  
  const fileList = Array.from(selectedFiles).map(filename => {
    const element = document.querySelector(`[data-filename="${filename}"]`);
    return {
      name: filename,
      status: element.dataset.status
    };
  });
  
  showModal('progress-modal');
  updateProgress(0, fileList.length, 'Preparing operation...');
  
  try {
    const response = await fetch('/api/bulk-operations/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        operation: operation,
        files: fileList
      })
    });
    
    const result = await response.json();
    showOperationResults(result);
    
    // Refresh files after operation
    if (result.summary.successful > 0) {
      await loadFiles();
      selectedFiles.clear();
      updateSelectionInfo();
      updateOperationButtons();
    }
    
  } catch (error) {
    console.error('Operation failed:', error);
    document.getElementById('operation-results').innerHTML = `
      <div class="result-item">
        <span class="result-file">Operation Failed</span>
        <span class="result-status error">Error: ${error.message}</span>
      </div>
    `;
  }
}

// Show operation results
function showOperationResults(result) {
  const resultsContainer = document.getElementById('operation-results');
  
  resultsContainer.innerHTML = result.results.map(item => `
    <div class="result-item">
      <span class="result-file">${item.file}</span>
      <span class="result-status ${item.success ? 'success' : 'error'}">
        ${item.success ? 'Success' : item.error}
      </span>
    </div>
  `).join('');
  
  updateProgress(result.summary.total, result.summary.total, 
    `Operation completed: ${result.summary.successful} successful, ${result.summary.failed} failed`);
}

// Progress functions
function updateProgress(current, total, text) {
  document.getElementById('progress-current').textContent = current;
  document.getElementById('progress-total').textContent = total;
  document.getElementById('progress-text').textContent = text;
  
  const percentage = total > 0 ? (current / total) * 100 : 0;
  document.getElementById('progress-fill').style.width = percentage + '%';
}

// Modal functions
function showModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

function showMoveDialog() {
  showModal('move-modal');
}

function confirmMove() {
  const destination = document.getElementById('destination-folder').value;
  closeModal('move-modal');
  performBulkOperation('move', { destination });
}

// Utility functions
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function getCsrfToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
});
</script>
{% endblock %}
